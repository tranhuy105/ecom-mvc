<!DOCTYPE html>
<html lang="en">
<head th:replace="~{fragments :: page_head('Products')}"></head>
<body>
<div th:replace="~{navigation :: navbar}"></div>

<div class="container-fluid content">
  <h2 class="my-4">Filters</h2>
  <form id="filterForm" class="mb-3" onsubmit="submitFilterForm()">
    <div class="row">
      <!-- Brand Filter -->
      <div class="col-md-3">
        <label for="brandFilter" class="form-label">Brand</label>
        <select id="brandFilter" class="form-control" name="b">
          <option value="">All Brands</option>
          <option th:each="brand : ${brands}" th:value="${brand.id}" th:text="${brand.name}"
                  th:selected="${b == brand.id}">

          </option>
        </select>
      </div>
      <!-- Min Price Filter -->
      <div class="col-md-3">
        <label for="minPrice" class="form-label">Min Price</label>
        <input type="number" id="minPrice" class="form-control" name="min_price" placeholder="Min Price" th:value="${minPrice}">
      </div>
      <!-- Max Price Filter -->
      <div class="col-md-3">
        <label for="maxPrice" class="form-label">Max Price</label>
        <input type="number" id="maxPrice" class="form-control" name="max_price" placeholder="Max Price" th:value="${maxPrice}">
      </div>

      <div class="col-md-1">
        <div class="mb-0 mb-md-2">&nbsp;</div>
        <button type="submit" class="btn btn-primary">Filter</button>
      </div>
    </div>



    <div class="row mt-3">
      <!-- Sort by -->
      <div class="col-md-6">
        <label for="sortFilter" class="form-label">Sort by</label>
        <select id="sortFilter" class="form-control" name="sort" onchange="submitFilterForm()">
          <option value="name" th:selected="${sort == 'name'}">Sort by Name</option>
          <option value="price" th:selected="${sort == 'price'}">Sort by Price</option>
          <option value="created_at" th:selected="${sort == 'created_at'}">Sort by Date</option>
        </select>
      </div>
      <!-- Sort Direction -->
      <div class="col-md-6">
        <label for="sortDirection" class="form-label">Sort Direction</label>
        <select id="sortDirection" class="form-control" name="sort_direction">
          <option value="asc" th:selected="${sortDirection == 'asc'}">Ascending</option>
          <option value="desc" th:selected="${sortDirection == 'desc'}">Descending</option>
        </select>
      </div>
    </div>
  </form>

  <div>
    <div class="row mx-2 mt-3">
      <div th:each="product : ${products}" class="col-md-3 px-2 mb-4 p-0">
        <div class="card h-100 card-hover">
          <div th:if="${product.images.size() > 0}" th:id="'carouselExampleControlsTh_' + ${product.id}" class="carousel slide">
            <div class="carousel-inner">
              <div th:each="image, iterStat : ${product.images}" class="carousel-item" th:classappend="${iterStat.index == 0 ? 'active' : ''}">
                <img th:src="@{${image.path}}" class="card-img-top" alt="Product Image" style="width: 100%; height: 360px; object-fit: cover;">
              </div>
            </div>
            <a class="carousel-control-prev" th:href="'#carouselExampleControlsTh_' + ${product.id}" role="button" data-slide="prev">
              <span class="fas fa-arrow-left" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" th:href="'#carouselExampleControlsTh_' + ${product.id}" role="button" data-slide="next">
              <span class="fas fa-arrow-right" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
          <div th:if="${product.images.size() == 0}">
            <img th:src="@{/images/default_user.jpg}" class="card-img-top" alt="Product Image" style="width: 100%; height: 360px; object-fit: cover;">
          </div>

          <div class="card-body">

            <a th:href="@{'/products/' + ${product.alias}}" class="card-link"
               style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
                           overflow: hidden; text-overflow: ellipsis; margin: 0; font-size: 20px"
               th:text="${product.name}">Product Name</a>
            <div>
              <div class="d-flex align-items-center">
                <div class="text-warning">
                  <i class="fa-star" th:classappend="${product.discountPercent >= 1 ? 'fas' : 'far'}"></i>
                  <i class="fa-star" th:classappend="${product.discountPercent >= 2 ? 'fas' : 'far'}"></i>
                  <i class="fa-star" th:classappend="${product.discountPercent >= 3 ? 'fas' : 'far'}"></i>
                  <i class="fa-star" th:classappend="${product.discountPercent >= 4 ? 'fas' : 'far'}"></i>
                  <i class="fa-star" th:classappend="${product.discountPercent >= 5 ? 'fas' : 'far'}"></i>
                </div>
                <span class="text-muted ml-2" th:text="'(' + ${product.discountPercent.intValue()} + ')'">0 reviews</span>
              </div>

              <div th:replace="~{fragments :: product-price}"></div>
            </div>
            <div class="d-flex justify-content-between flex-column">
              <p class="card-text text-info mb-0" th:text="${product.category.name}">Category</p>
              <p class="card-text text-muted"
                 th:text="${product.shortDescription}"
                 style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; height: 3.5rem; line-height: 1.75rem; margin: 0;">
                Short description of the product.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div th:replace="~{navigation :: pagination(totalItems=${totalItems}, currentPage=${currentPage}, totalPages=${totalPages}, startCount=${startCount}, endCount=${endCount}, q=${q}, baseUrl=${'/products'})}"></div>
</div>

<div th:replace="~{navigation :: footer}"></div>
</body>
<script>
  function submitFilterForm() {
    const form = $('#filterForm');
    let queryString = form.serialize();
    const currentUrl = new URL(window.location.href);
    let params = new URLSearchParams(currentUrl.search);

    queryString.split('&').forEach(function(param) {
      const [key, value] = param.split('=');
      console.log(key, value)
      if (value && value !== "") {
        params.set(key, value);
      } else {
        params.delete(key);
      }
    });

    window.location.href = currentUrl.pathname + '?' + params.toString();
  }

</script>
<script th:src="@{/js/pagination.js}"></script>
<script th:src="@{/js/search.js}"></script>
</html>